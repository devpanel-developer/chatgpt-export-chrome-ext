function d(t){const c=Array.from(document.querySelectorAll("[data-message-author-role]")).map((e,o)=>{const r=e.getAttribute("data-message-author-role")==="user"?"user":"assistant",n=e.dataset.messageId||`msg-${o}`;if(t.scope==="partial"&&!t.selectedIds.has(n)||r==="user"&&!t.includeUser||r==="assistant"&&!t.includeAssistant)return null;const l=m(e);return{id:n,role:r,blocks:l}}).filter(e=>!!e);return{meta:{sourceApp:"chatgpt",url:location.href,title:document.title,capturedAtISO:new Date().toISOString(),selection:{scope:t.scope,messageIds:c.map(e=>e.id)}},messages:c,assets:[],annotations:{warnings:[],redactions:[]}}}function m(t){var c;const s=[];return t.querySelectorAll("h1,h2,h3,h4,h5,h6,p,pre,blockquote,table").forEach(e=>{var o,r;if(e.tagName==="P"&&s.push({type:"paragraph",text:((o=e.textContent)==null?void 0:o.trim())||""}),/H[1-6]/.test(e.tagName)&&s.push({type:"heading",level:Number(e.tagName[1]),text:((r=e.textContent)==null?void 0:r.trim())||""}),e.tagName==="PRE"&&s.push({type:"code",text:e.textContent||""}),e.tagName==="BLOCKQUOTE"&&s.push({type:"quote",text:e.textContent||""}),e.tagName==="TABLE"){const n=Array.from(e.querySelectorAll("tr")).map(l=>Array.from(l.querySelectorAll("th,td")).map(p=>{var i;return((i=p.textContent)==null?void 0:i.trim())||""}));s.push({type:"table",rows:n})}}),s.length||s.push({type:"paragraph",text:((c=t.textContent)==null?void 0:c.trim())||""}),s}const h=/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi,g=/(sk-[A-Za-z0-9]{20,}|AIza[0-9A-Za-z\-_]{35}|ghp_[A-Za-z0-9]{36})/g;function b(t,s){const c=structuredClone(t);for(const e of c.messages){for(const o of e.blocks)(o.type==="paragraph"||o.type==="quote"||o.type==="heading")&&(o.text=u(o.text,s)),o.type==="code"&&(o.text=u(o.text,s));s.removeImages&&(e.blocks=e.blocks.filter(o=>o.type!=="image"))}return c}function u(t,s){let c=t;return s.maskEmails&&(c=c.replace(h,"[REDACTED_EMAIL]")),s.maskSecrets&&(c=c.replace(g,"[REDACTED_SECRET]")),c}const a={selectMode:!1,includeUser:!0,includeAssistant:!0,selectedIds:new Set,scope:"all"};function k(){const t=document.createElement("aside");t.setAttribute("aria-label","Chat export controls"),t.style.cssText="position:fixed;bottom:16px;right:16px;z-index:999999;background:#111;color:#fff;padding:12px;border-radius:10px;width:280px;font:12px sans-serif;",t.innerHTML=`
    <button id="cep-toggle" aria-label="Toggle select mode">Select mode: off</button>
    <div><label><input type="checkbox" id="cep-user" checked> Include user</label></div>
    <div><label><input type="checkbox" id="cep-assistant" checked> Include assistant</label></div>
    <div><label><input type="checkbox" id="cep-mask-emails"> Mask emails</label></div>
    <div><label><input type="checkbox" id="cep-mask-secrets"> Mask tokens/keys</label></div>
    <div><label><input type="checkbox" id="cep-remove-images"> Remove images</label></div>
    <div><label>Module
      <select id="cep-module">
        <option value="exporter-markdown">Markdown</option>
        <option value="exporter-json">JSON</option>
        <option value="publisher-gdocs">Google Docs</option>
      </select>
    </label></div>
    <button id="cep-preview">Preview selection</button>
    <button id="cep-export">Run module</button>
    <pre id="cep-status" aria-live="polite" style="white-space:pre-wrap;max-height:120px;overflow:auto"></pre>
  `,document.body.appendChild(t);const s=t.querySelector("#cep-toggle"),c=t.querySelector("#cep-status");s.addEventListener("click",()=>{a.selectMode=!a.selectMode,a.scope=a.selectMode?"partial":"all",s.textContent=`Select mode: ${a.selectMode?"on":"off"}`,x()}),t.querySelector("#cep-user").addEventListener("change",e=>{a.includeUser=e.target.checked}),t.querySelector("#cep-assistant").addEventListener("change",e=>{a.includeAssistant=e.target.checked}),t.querySelector("#cep-preview").addEventListener("click",()=>{const e=d({scope:a.scope,includeUser:a.includeUser,includeAssistant:a.includeAssistant,selectedIds:a.selectedIds});c.textContent=`${e.messages.length} messages selected`}),t.querySelector("#cep-export").addEventListener("click",async()=>{const e=b(d({scope:a.scope,includeUser:a.includeUser,includeAssistant:a.includeAssistant,selectedIds:a.selectedIds}),{maskEmails:t.querySelector("#cep-mask-emails").checked,maskSecrets:t.querySelector("#cep-mask-secrets").checked,removeImages:t.querySelector("#cep-remove-images").checked}),o=t.querySelector("#cep-module").value,r=await chrome.runtime.sendMessage({type:"RUN_MODULE",moduleId:o,ccd:e});c.textContent=r!=null&&r.ok?`Success: ${r.message}`:`Error: ${(r==null?void 0:r.error)||"Unknown"}`})}function x(){document.querySelectorAll(".cep-checkbox").forEach(t=>t.remove()),a.selectMode&&Array.from(document.querySelectorAll("[data-message-author-role]")).forEach((t,s)=>{const c=t.dataset.messageId||`msg-${s}`,e=document.createElement("input");e.type="checkbox",e.className="cep-checkbox",e.style.cssText="margin-right:8px;outline:2px solid #19c37d",e.checked=a.selectedIds.has(c),e.setAttribute("aria-label",`Select message ${s+1}`),e.addEventListener("change",()=>{e.checked?a.selectedIds.add(c):a.selectedIds.delete(c)}),t.prepend(e)})}k();
